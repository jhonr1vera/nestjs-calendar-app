{{> head }}
<!-- FullCalendar CSS -->
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>

<body class="bg-light">
    {{> header}}
    <div class="container mt-4 mb-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
             <h2>{{ t "messages.WELCOME" }}, {{ user.firstName }}</h2>
        </div>

        <div class="card shadow-sm">
            <div class="card-body p-0">
                <div id="calendar" style="min-height: 800px;"></div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="createEventModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">{{ t "messages.CREATE_EVENT" }}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="createEventForm">
                        <div id="error-alert" class="alert alert-danger d-none"></div>
                        <div class="mb-3">
                            <label for="eventName" class="form-label">{{ t "messages.EVENT_NAME" }}</label>
                            <input type="text" class="form-control" id="eventName" name="title" required>
                        </div>
                        <div class="mb-3">
                            <label for="eventDescription" class="form-label">{{ t "messages.EVENT_DESCRIPTION" }}</label>
                            <textarea class="form-control" id="eventDescription" name="description" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="eventStart" class="form-label">{{ t "messages.EVENT_START" }}</label>
                            <input type="datetime-local" class="form-control" id="eventStart" name="startAt" required>
                        </div>
                        <div class="mb-3">
                            <label for="eventEnd" class="form-label">{{ t "messages.EVENT_END" }}</label>
                            <input type="datetime-local" class="form-control" id="eventEnd" name="endAt" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ t "messages.CLOSE" }}</button>
                    <button type="button" class="btn btn-primary" onclick="submitEvent()">{{ t "messages.SAVE" }}</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="viewEventModal" tabindex="1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">{{ t "messages.EVENT_DETAILS" }}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <dl class="row">
                        <dt class="col-sm-4">{{ t "messages.EVENT_NAME" }}</dt>
                        <dd class="col-sm-8" id="viewEventTitle"></dd>

                        <dt class="col-sm-4">{{ t "messages.EVENT_DESCRIPTION" }}</dt>
                        <dd class="col-sm-8" id="viewEventDescription"></dd>

                        <dt class="col-sm-4">{{ t "messages.EVENT_START" }}</dt>
                        <dd class="col-sm-8" id="viewEventStart"></dd>

                        <dt class="col-sm-4">{{ t "messages.EVENT_END" }}</dt>
                        <dd class="col-sm-8" id="viewEventEnd"></dd>

                        <dt class="col-sm-12 mt-3">{{ t "messages.REMINDERS" }}</dt>
                        <dd class="col-sm-12" id="viewEventReminders">
                        </dd>
                    </dl>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ t "messages.CLOSE" }}</button>
                    <button type="button" class="btn btn-primary" onclick="openCreateReminderModal()">{{ t "messages.ADD_REMINDER" }}</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Reminder Modal -->
    <div class="modal fade" id="createReminderModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">{{ t "messages.CREATE_REMINDER" }}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="createReminderForm">
                        <input type="hidden" id="reminderEventId" name="eventId">
                        <div class="mb-3">
                            <label for="reminderDescription" class="form-label">{{ t "messages.REMINDER_DESCRIPTION" }}</label>
                            <input type="text" class="form-control" id="reminderDescription" name="description" required>
                        </div>
                        <div class="mb-3">
                            <label for="reminderDate" class="form-label">{{ t "messages.REMINDER_DATE" }}</label>
                            <input type="datetime-local" class="form-control" id="reminderDate" name="date" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeCreateReminderModal()">{{ t "messages.CLOSE" }}</button>
                    <button type="button" class="btn btn-primary" onclick="submitReminder()">{{ t "messages.SAVE" }}</button>
                </div>
            </div>
        </div>
    </div>
    
{{> foot}}

<script>
    let calendar;
    let modal;
    let viewModal;
    let reminderModal;
    let errorAlert;
    let currentEventId;

    document.addEventListener('DOMContentLoaded', function() {
        const calendarEl = document.getElementById('calendar');
        modal = new bootstrap.Modal(document.getElementById('createEventModal'));
        viewModal = new bootstrap.Modal(document.getElementById('viewEventModal'));
        reminderModal = new bootstrap.Modal(document.getElementById('createReminderModal'));
        errorAlert = document.getElementById('error-alert');

        calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth'
                {{!-- right: 'dayGridMonth,timeGridWeek,timeGridDay' --}}
            },
            selectable: true,
            editable: true,
            eventClick: function(info) {
                currentEventId = info.event.id;
                openViewModal(info.event);
            },
            dateClick: function(info) {
                openCreateModal(info.dateStr);
            },
            events: async function(info, successCallback, failureCallback) {
                try {
                    const response = await fetch('/events/me');
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    const data = await response.json();
                    
                    const events = data.map(event => ({
                        id: event.id,
                        title: event.title,
                        start: event.startAt,
                        end: event.endAt,
                        extendedProps: {
                            description: event.description,
                            reminders: event.reminders
                        }
                    }));
                    
                    successCallback(events);
                } catch (error) {
                    console.error('Error fetching events:', error);
                    failureCallback(error);
                }
            }
        });

        calendar.render();
    });

    function openViewModal(event) {
        document.getElementById('viewEventTitle').textContent = event.title;
        document.getElementById('viewEventDescription').textContent = event.extendedProps.description || '-';
        document.getElementById('viewEventStart').textContent = event.start ? event.start.toLocaleString() : '-';
        document.getElementById('viewEventEnd').textContent = event.end ? event.end.toLocaleString() : '-';
        
        if (event.id) currentEventId = event.id;

        const remindersDiv = document.getElementById('viewEventReminders');
        remindersDiv.innerHTML = '';

        const reminders = event.extendedProps.reminders;
        if (reminders && reminders.length > 0) {
            reminders.forEach(reminder => {
                const card = document.createElement('div');
                card.className = 'card mb-2';
                
                const cardBody = document.createElement('div');
                cardBody.className = 'card-body p-2';
                
                const date = new Date(reminder.date);
                
                const header = document.createElement('div');
                header.className = 'd-flex justify-content-between align-items-start';

                const title = document.createElement('h6');
                title.className = 'card-subtitle mb-1 text-muted';
                title.style.fontSize = '0.85rem';
                title.textContent = date.toLocaleString();
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'btn btn-link btn-sm p-0 text-danger';
                deleteBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash" viewBox="0 0 16 16">
                        <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                        <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                    </svg>
                `;
                deleteBtn.onclick = () => deleteReminder(reminder.id);

                header.appendChild(title);
                header.appendChild(deleteBtn);

                const text = document.createElement('p');
                text.className = 'card-text mb-0';
                text.textContent = reminder.description || 'Reminder';
                
                cardBody.appendChild(header);
                cardBody.appendChild(text);
                card.appendChild(cardBody);
                remindersDiv.appendChild(card);
            });
        } else {
            remindersDiv.textContent = '{{ t "messages.NO_REMINDERS" }}';
        }

        viewModal.show();
    }

    function openCreateReminderModal() {
        viewModal.hide();
        document.getElementById('createReminderForm').reset();
        document.getElementById('reminderEventId').value = currentEventId;
        
        const now = new Date();
        now.setHours(now.getHours() + 1);
        document.getElementById('reminderDate').value = now.toISOString().slice(0, 16);

        reminderModal.show();
    }

    function closeCreateReminderModal() {
        reminderModal.hide();
        const event = calendar.getEventById(currentEventId);
        if (event) {
            openViewModal(event);
        }
    }

    async function submitReminder() {
        const form = document.getElementById('createReminderForm');
        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());

        if (!data.description || !data.date) {
            alert('Please fill in required fields');
            return;
        }

        const payload = {
            description: data.description,
            date: data.date,
            event: { id: parseInt(currentEventId) }
        };

        try {
            const response = await fetch('/reminders', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            });

            if (response.ok) {
                reminderModal.hide();
                calendar.refetchEvents();
                
                // Fetch single event to update view immediately
                const eventResponse = await fetch(`/events/${currentEventId}`);
                if (eventResponse.ok) {
                    const updatedEventData = await eventResponse.json();
                    const pseudoEvent = {
                        id: updatedEventData.id,
                        title: updatedEventData.title,
                        start: new Date(updatedEventData.startAt),
                        end: new Date(updatedEventData.endAt),
                        extendedProps: {
                            description: updatedEventData.description,
                            reminders: updatedEventData.reminders
                        }
                    };
                    openViewModal(pseudoEvent);
                }
            } else {
                alert('{{ t "messages.ERROR_CREATING_REMINDER" }}');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('{{ t "messages.ERROR_CREATING_REMINDER" }}');
        }
    }

    async function deleteReminder(id) {
        if (!confirm('{{ t "messages.DELETE_REMINDER_CONFIRM" }}')) return;

        try {
            const response = await fetch(`/reminders/${id}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                // Fetch single event to update view immediately
                const eventResponse = await fetch(`/events/${currentEventId}`);
                if (eventResponse.ok) {
                    const updatedEventData = await eventResponse.json();
                    const pseudoEvent = {
                        id: updatedEventData.id,
                        title: updatedEventData.title,
                        start: new Date(updatedEventData.startAt),
                        end: new Date(updatedEventData.endAt),
                        extendedProps: {
                            description: updatedEventData.description,
                            reminders: updatedEventData.reminders
                        }
                    };
                    openViewModal(pseudoEvent);
                }
            } else {
                alert('{{ t "messages.ERROR_DELETING_REMINDER" }}');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('{{ t "messages.ERROR_DELETING_REMINDER" }}');
        }
    }

    function openCreateModal(dateStr) {
        
        // Set default start time to clicked date at 09:00
        const start = new Date(dateStr);
        start.setHours(9, 0, 0);
        
        const end = new Date(start);
        end.setHours(10, 0, 0);

        const formatDateTime = (date) => {
            return date.toISOString().slice(0, 16);
        };

        document.getElementById('eventStart').value = formatDateTime(start);
        document.getElementById('eventEnd').value = formatDateTime(end);
        document.getElementById('createEventForm').reset();
        
        document.getElementById('eventStart').value = formatDateTime(start);
        document.getElementById('eventEnd').value = formatDateTime(end);

        document.getElementById('eventEnd').value = formatDateTime(end);

        errorAlert.classList.add('d-none');
        errorAlert.textContent = '';

        modal.show();
    }

    async function submitEvent() {
        const form = document.getElementById('createEventForm');
        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());

        if (!data.title || !data.startAt || !data.endAt) {
            errorAlert.textContent = '{{ t "validators.DATA_IS_REQUIRED"}}';
            errorAlert.classList.remove('d-none');
            return;
        }

        try {
            const response = await fetch('/events', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });

            if (response.ok) {
                const newEvent = await response.json();
                calendar.addEvent({
                    title: newEvent.title,
                    start: newEvent.startAt,
                    end: newEvent.endAt
                });
                modal.hide();
                form.reset();
            } else {
                const result = await response.json();
                console.log('Error result:', result);
                let errorMsg = 'An error occurred';
                errorAlert.classList.remove('d-none');
                if (result.message) {
                    const msgData = result.message;
                    if (typeof msgData === 'string') {
                        errorMsg = msgData;
                    } else if (typeof msgData === 'object') {
                        if (Array.isArray(msgData.message)) {
                        errorMsg = msgData.message.join(', ');
                    } else if (msgData.message) {
                        errorMsg = msgData.message;
                    }
                }
            }
            
            errorAlert.textContent = errorMsg;
            errorAlert.classList.remove('d-none');
          }
        } catch (error) {
            errorAlert.textContent = 'A network error occurred. Please try again.';
            errorAlert.classList.remove('d-none');
        }
    }
</script>
</body>
</html>
